name: Benchmark

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Benchmark (${{ matrix.os }}, Node ${{ matrix.node }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node: [22, 24]

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      - name: Cache pnpm
        uses: actions/cache@v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm run build

      - name: Run benchmark
        id: benchmark
        run: |
          # Run benchmark and capture output
          OUTPUT=$(pnpm bench:quick 2>&1)
          echo "$OUTPUT"

          # Extract results section
          RESULTS=$(echo "$OUTPUT" | sed -n '/^=\+$/,/^=\+$/p' | tail -n +2)

          # Save to file for the comment
          {
            echo "## ðŸš€ Benchmark Results"
            echo ""
            echo "<details>"
            echo "<summary>Click to expand full results</summary>"
            echo ""
            echo '```'
            echo "$RESULTS"
            echo '```'
            echo ""
            echo "</details>"
            echo ""
            echo "### Summary"
            echo ""
            echo "| Scenario | fetch-rs RPS | node-http RPS | Speedup |"
            echo "|----------|-------------|---------------|---------|"
            echo "$OUTPUT" | grep "^Comparison:" | while read -r line; do
              scenario=$(echo "$line" | sed 's/Comparison: fetch-rs is \(.*\)x RPS.*/\1/')
              echo "| - | - | - | ${scenario}x faster |"
            done
            echo ""
            echo "*Benchmark run on GitHub Actions (ubuntu-latest)*"
          } > benchmark-results.md

          # Also create a simpler summary by parsing the output
          {
            echo "## ðŸš€ Benchmark Results"
            echo ""
            echo "| Scenario | fetch-rs | node-http | Improvement |"
            echo "|----------|----------|-----------|-------------|"
          } > benchmark-summary.md

          # Parse JSON results (use sed instead of grep -oP for portability)
          # Output format has header/separator lines, so use -A10 to capture the full section
          JSON_FETCH=$(echo "$OUTPUT" | grep -A10 "## JSON" | grep "^fetch-rs" | awk '{print $2}' | tr -d ',')
          JSON_NODE=$(echo "$OUTPUT" | grep -A10 "## JSON" | grep "^node-http" | awk '{print $2}' | tr -d ',')
          JSON_COMP=$(echo "$OUTPUT" | grep -A10 "## JSON" | grep "Comparison" | sed -n 's/.*is \([0-9.]*\)x RPS.*/\1/p')

          TEXT_FETCH=$(echo "$OUTPUT" | grep -A10 "## TEXT" | grep "^fetch-rs" | awk '{print $2}' | tr -d ',')
          TEXT_NODE=$(echo "$OUTPUT" | grep -A10 "## TEXT" | grep "^node-http" | awk '{print $2}' | tr -d ',')
          TEXT_COMP=$(echo "$OUTPUT" | grep -A10 "## TEXT" | grep "Comparison" | sed -n 's/.*is \([0-9.]*\)x RPS.*/\1/p')

          ECHO_FETCH=$(echo "$OUTPUT" | grep -A10 "## ECHO" | grep "^fetch-rs" | awk '{print $2}' | tr -d ',')
          ECHO_NODE=$(echo "$OUTPUT" | grep -A10 "## ECHO" | grep "^node-http" | awk '{print $2}' | tr -d ',')
          ECHO_COMP=$(echo "$OUTPUT" | grep -A10 "## ECHO" | grep "Comparison" | sed -n 's/.*is \([0-9.]*\)x RPS.*/\1/p')

          {
            echo "| JSON | ${JSON_FETCH:-N/A} RPS | ${JSON_NODE:-N/A} RPS | **${JSON_COMP:-N/A}x faster** |"
            echo "| Text | ${TEXT_FETCH:-N/A} RPS | ${TEXT_NODE:-N/A} RPS | **${TEXT_COMP:-N/A}x faster** |"
            echo "| Echo | ${ECHO_FETCH:-N/A} RPS | ${ECHO_NODE:-N/A} RPS | **${ECHO_COMP:-N/A}x faster** |"
            echo ""
            echo "*Benchmark run on \`${{ matrix.os }}\` with Node.js ${{ matrix.node }}*"
          } >> benchmark-summary.md

      - name: Comment on PR
        if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.node == 22
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('benchmark-summary.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸš€ Benchmark Results')
            );

            const body = summary;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Summary
        run: |
          cat benchmark-summary.md >> $GITHUB_STEP_SUMMARY
